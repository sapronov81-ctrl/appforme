name: Android Release (APK & AAB)

on:
  workflow_dispatch: # запуск вручную
  push:
    tags:
      - "v*.*.*" # запуск при пуше тега (например, v1.0.0)

env:
  JAVA_VERSION: "17"
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  PATH: /usr/local/lib/android/sdk/cmdline-tools/latest/bin:$PATH
  GRADLE_OPTS: "-Dorg.gradle.daemon=true -Dorg.gradle.jvmargs='-Xmx4g -Dfile.encoding=UTF-8' -Dorg.gradle.parallel=true -Dorg.gradle.configuration-cache=true"
  CI_GRADLE_ARGS: "--stacktrace --no-daemon -Pci=true"
  VERSION_NAME: ${{ github.ref_name }}
  VERSION_CODE: ${{ github.run_number }}

jobs:
  build:
    name: Build Android App
    runs-on: ubuntu-22.04  # гарантировано Linux с sudo и apt-get

    steps:
      # 1️⃣ Проверка окружения
      - name: Verify environment
        run: |
          echo "Runner OS: $RUNNER_OS"
          uname -a

      # 2️⃣ Установка системных пакетов (tar, zip и др.)
      - name: Install base packages
        run: |
          sudo apt-get update -y
          sudo apt-get install -y tar unzip zip

      # 3️⃣ Клонирование репозитория
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 4️⃣ Установка Flutter SDK
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.x'
          channel: 'stable'

      # 5️⃣ Проверка зависимостей
      - name: Flutter doctor
        run: flutter doctor -v

      # 6️⃣ Установка Android SDK 34 (устойчивый билд)
      - name: Install Android SDK 34
        run: |
          echo "Installing Android SDK 34..."
          yes | sudo /usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager --licenses || true
          sudo /usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager "platforms;android-34" "build-tools;34.0.0"

      # 7️⃣ Установка зависимостей Flutter
      - name: Flutter pub get
        run: flutter pub get

      # 8️⃣ Генерация нативных директорий (если нет
